name: Promote to INT/PROD

on:
  workflow_dispatch:
    inputs:
      source_tag:
        description: "Source image tag to promote (e.g., main-20260215-143022)"
        required: true
        type: string

jobs:
  # Promote to INT environment (retag the TEST image)
  promote-int:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create INT tag
        id: docker_tag
        run: echo "tag=int_$(date '+%Y-%m-%d_%H%M%S')" >> "$GITHUB_OUTPUT"

      - name: Retag image for INT
        run: |
          echo "Promoting ${{ inputs.source_tag }} to ${{ steps.docker_tag.outputs.tag }}"
          docker buildx imagetools create \
            --tag ghcr.io/${{ github.repository }}:${{ steps.docker_tag.outputs.tag }} \
            ghcr.io/${{ github.repository }}:${{ inputs.source_tag }}

  # Promote to PROD environment (retag the same TEST image)
  promote-prod:
    if: github.ref == 'refs/heads/main'
    needs: promote-int
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create PROD tag
        id: docker_tag
        run: echo "tag=prod_$(date '+%Y-%m-%d_%H%M%S')" >> "$GITHUB_OUTPUT"

      - name: Retag image for PROD
        run: |
          echo "Promoting ${{ inputs.source_tag }} to ${{ steps.docker_tag.outputs.tag }}"
          docker buildx imagetools create \
            --tag ghcr.io/${{ github.repository }}:${{ steps.docker_tag.outputs.tag }} \
            ghcr.io/${{ github.repository }}:${{ inputs.source_tag }}
