name: Promote to Main

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "promote" to confirm promotion from develop to main'
        required: true
        type: string

jobs:
  promote:
    name: Create Promotion PR
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'promote' }}

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for differences
        id: diff
        run: |
          git fetch origin main develop
          DIFF_COUNT=$(git rev-list --count origin/main..origin/develop)
          echo "diff_count=$DIFF_COUNT" >> $GITHUB_OUTPUT
          if [ "$DIFF_COUNT" -eq "0" ]; then
            echo "No changes to promote"
            exit 0
          fi
          echo "Found $DIFF_COUNT commits to promote"

      - name: Create Pull Request
        if: ${{ steps.diff.outputs.diff_count != '0' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING_PR=$(gh pr list --base main --head develop --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists"
            gh pr view $EXISTING_PR --json url --jq '.url'
            exit 0
          fi
          CHANGES=$(git log --oneline origin/main..origin/develop)
          gh pr create \
            --base main \
            --head develop \
            --title "chore: promote develop to main" \
            --body "$(cat <<EOF
## Promotion PR

This PR promotes changes from develop to main.

### Changes included
$CHANGES

### Checklist
- [ ] All CI checks pass
- [ ] Changes have been tested on develop
- [ ] Ready for release

---
*Created by promote workflow*
EOF
)"
