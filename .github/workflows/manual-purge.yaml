name: Manual Cache Purge

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - test
          - int
          - prod
      mode:
        description: "Purge mode"
        required: true
        type: choice
        options:
          - full
          - selective-24h
        default: full

jobs:
  purge-cache:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Set environment-specific variables
        id: env
        run: |
          case "${{ inputs.environment }}" in
            test)
              echo "cache_endpoint=https://lindas-cached-purge.test.cluster.ldbar.ch/" >> "$GITHUB_OUTPUT"
              echo "sparql_endpoint=https://test.ld.admin.ch/query" >> "$GITHUB_OUTPUT"
              ;;
            int)
              echo "cache_endpoint=https://lindas-cached-purge.int.cluster.ldbar.ch/" >> "$GITHUB_OUTPUT"
              echo "sparql_endpoint=https://int.ld.admin.ch/query" >> "$GITHUB_OUTPUT"
              ;;
            prod)
              echo "cache_endpoint=https://lindas-cached-purge.cluster.ldbar.ch/" >> "$GITHUB_OUTPUT"
              echo "sparql_endpoint=https://ld.admin.ch/query" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Set purge date
        id: date
        run: |
          if [ "${{ inputs.mode }}" = "full" ]; then
            echo "previous_date=1970-01-01T00:00:00Z" >> "$GITHUB_OUTPUT"
            echo "Mode: full purge (all datasets)"
          else
            echo "previous_date=$(date -u -d '24 hours ago' '+%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_OUTPUT"
            echo "Mode: selective purge (last 24 hours)"
          fi

      - name: Run cache purge
        uses: docker://ghcr.io/swissfederalarchives/lindas-clear-sparql-cache-endpoint:main
        env:
          CACHE_ENDPOINT: ${{ steps.env.outputs.cache_endpoint }}
          CACHE_ENDPOINT_USERNAME: admin
          CACHE_ENDPOINT_PASSWORD: ${{ secrets.CACHE_ENDPOINT_PASSWORD }}
          CACHE_DEFAULT_ENTRY_NAME: default
          CACHE_TAG_HEADER: xkey
          SUPPORT_URL_ENCODED: "true"
          SPARQL_ENDPOINT_URL: ${{ steps.env.outputs.sparql_endpoint }}
          S3_ENABLED: "false"
          DEFAULT_PREVIOUS_DATE: ${{ steps.date.outputs.previous_date }}
