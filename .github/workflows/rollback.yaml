name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - test
          - int
          - prod
      target_version:
        description: 'Version to rollback to (e.g., 0.3.1)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: swissfederalarchives/lindas-clear-sparql-cache-endpoint

jobs:
  rollback:
    name: Rollback ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment == 'prod' && 'production' || '' }}

    permissions:
      packages: write

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull target version
        run: |
          ENV="${{ github.event.inputs.environment }}"
          VERSION="${{ github.event.inputs.target_version }}"
          SOURCE_TAG="${VERSION}-${ENV}"
          
          echo "Pulling $REGISTRY/$IMAGE_NAME:$SOURCE_TAG"
          docker pull $REGISTRY/$IMAGE_NAME:$SOURCE_TAG

      - name: Re-tag as rollback
        run: |
          ENV="${{ github.event.inputs.environment }}"
          VERSION="${{ github.event.inputs.target_version }}"
          SOURCE_TAG="${VERSION}-${ENV}"
          ROLLBACK_TAG="${ENV}-rollback"
          
          echo "Re-tagging $SOURCE_TAG -> $ROLLBACK_TAG"
          docker tag $REGISTRY/$IMAGE_NAME:$SOURCE_TAG $REGISTRY/$IMAGE_NAME:$ROLLBACK_TAG
          docker push $REGISTRY/$IMAGE_NAME:$ROLLBACK_TAG

      - name: Summary
        run: |
          echo "## Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Rolled back to |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ github.event.inputs.environment }} | \`${{ github.event.inputs.target_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tag \`${{ github.event.inputs.environment }}-rollback\` now points to version ${{ github.event.inputs.target_version }}" >> $GITHUB_STEP_SUMMARY
